<% include ./header.ejs %>
<div class="row">
    <div class="col-md-4"></div>
    <div class="col-md-8">推荐信息</div>
</div>
<div class="row">
    <!--左侧边栏-->
    <div class="col-md-4">
        <script language="javascript">
            $(document).ready(function() {
                $.ui.dynatree.nodedatadefaults["icon"] = false;
                $("#tree").dynatree({
                    title: "Lazy loading sample",
                    fx: {height: "toggle", duration: 200},
                    autoFocus: false, // Set focus to first child, when expanding or lazy-loading.
                    checkbox: true,
                    onSelect: function(flag, node){
                        if (flag){
                            addSelect(node.data.key, node.data.title);
                        } else {
                            rmvSelect(node.data.key);
                        }
                    },
                    initAjax: {
                        url: "http://202.121.178.141/cgi-bin/MDPA/HPOTreeData.cgi",
                        data: {"ID": 'all'}
                    },
                    onLazyRead: function (node) {
                        node.appendAjax({
                            url: "http://202.121.178.141/cgi-bin/MDPA/HPOTreeData.cgi",
                            data: {"ID": node.data.key}
                            // We don't want the next line in production code:
                            // debugLazyDelay: 750
                        });
                    },
                    onActivate: function (node) {

                    }
                });
            });
        </script>
        <div class=mainBox id="tree">
        </div>
    </div>
    <div class="col-md-8">
        <!--搜索栏-->
        <div class="row search-area">
            <script type="text/javascript">
                $(document).ready(function() {
                    $("#sel_menu2").select2({
                        multiple:true,
                        placeholder:'Please enter some terms or keywords',
                        ajax:
                        {
                            url:"http://202.121.178.141/cgi-bin/MDPA/SearchDB.cgi",
                            dataType: 'json',
                            delay: 600,
                            contentType:"application/x-www-form-urlencoded;charset=UTF-8",
                            data: function (params){
                                return {
                                    q: params.term, // search term
                                    page: params.page
                                };
                            },
                            processResults: function (data, page)
                            {
                                return{
                                    results: data.items
                                };
                            },
                            cache:true
                        },
                        escapeMarkup: function (markup)
                        {
                            //console.debug(markup)
                            return markup;
                        }, // let our custom formatter work
                        minimumInputLength: 2,
                        //maximumInputLength: 40,
                        templateResult:formatRepo,
                        templateSelection:formatRepoSelection
                    }).on("select2:select", function(e)//搜索栏中添加一项时，与列表进行同步
                    {
                        insertRow(e.params.data.id.substr(3));
                    }).on("select2:unselect", function(e){//搜索栏中删除一项时，与列表进行同步
                        removeRow(e.params.data.id.substr(3));
                    })
                });
                function formatRepo(repo)
                {
                    if (repo.loading) return repo.text;
                    repo.text = repo.name
                    repo.id = repo.id
                    var markup = '<option class="select2-option-click" value='+repo.id+'>'+ repo.id+'|'+repo.text+'</option>';
                    return markup;
                }

                function formatRepoSelection(repo){
                    repo.selected = true;
                    repo.name = repo.id
                    if(repo.id == null || repo.name == ""){
                        repo.id = 'Please type items'
                        repo.name = repo.text
                    }
                    return repo.text;
                }

                //向搜索栏中添加一项，并且与列表进行同步
                //这是由于从select2外部直接修改标签元素时，不会触发事件，所以需要同步
                function addSelect(id, name){
                    var ID = 'HP:' + id;
                    var $searchBox = $('#sel_menu2');
                    if ($.inArray(ID, $searchBox.val()) != -1) return;
                    var op1 = '<option value="'+ID+'" selected>'+name+'</option>'
                    $searchBox.append(op1).trigger("change");
                    insertRow(id);
                }

                //从搜索栏中删除一项，并且与列表进行同步
                function rmvSelect(id){
                    var $searchBox = $('#sel_menu2');
                    var found = 0;
                    for (var i in $searchBox.children())
                    {
                        if ($searchBox.children()[i].value == "HP:" + id)
                        {
                            $searchBox.children()[i].remove();
                            found = 1;
                            break;
                        }
                    }
                    for (var i in $searchBox.children())
                    {
                        if ($searchBox.children()[i].value == "HP:" + id)
                        {
                            $searchBox.children()[i].remove();
                            found = 1;
                            break;
                        }
                    }
                    if (found === 1)
                    {
                        $searchBox.trigger('change');
                        removeRow(id);
                    }
                }
            </script>
            <FORM METHOD=GET id='form1' ACTION="http://202.121.178.141/cgi-bin/Test/main.page.pl">
                <div class="col-md-10 search-div">
                    <select id="sel_menu2" name="HPO" multiple="multiple" class="form-control">
                    </select>
                </div>
                <input type='button' value="GO" class="btn btn-primary col-md-2 search-btn" onclick=''>
            </FORM>
        </div>
        <!--列表-->
        <script type="text/javascript">
            //列表在一开始是隐藏的
            $(document).ready(function() {
                $("#diseaseTable").hide();
            })
            //在列表中添加一项
            function insertRow(id) {
                $("#diseaseTable").show();
                var $table = $('#tableBody');
                $.ajax(
                        {
                            type : 'GET',
                            url : 'http://202.121.178.141/cgi-bin/MDPA/NodeInfo.cgi',
                            data : "ID=" + id,
                            success : function(data)
                            {
                                var row = $.parseJSON(data);
                                var newRow = $('<tr role="row" class="color-palette" id="row-hp-'+ id +'"></tr>');
                                var newName = $('<td>'+row.chname+'</td>');
                                if (row.description == "NULL") row.description = "";
                                var newDcrp = $('<td>'+row.description+'</td>');
                                var links = "";
                                for (var i in row.children){
                                    links += '<a onclick="addSelect(\''+row.children[i].key+'\', \''+row.children[i].chname+
                                                    '\')">'+row.children[i].chname+'</a>&nbsp;';
                                }
                                var newLeaf = $('<td>'+links+'</td>');
                                newRow.append(newName);
                                newRow.append(newDcrp);
                                newRow.append(newLeaf);
                                $table.append(newRow);
                            },
                            error : function()
                            {
                                alert("网络连接异常");
                            }
                        });
            }
            //在列表中删除一项
            function removeRow(id) {
                var $table = $('#tableBody');
                $table.children('#row-hp-'+id).remove();
                if ($table.children().length == 0) $("#diseaseTable").hide();
            }
        </script>
        <div class="row">
            <table id="diseaseTable" class="table table-bordered table-striped dataTable" role="grid">
                <thead>
                <tr role="row">
                    <th>名字</th>
                    <th>描述</th>
                    <th>子节点</th>
                </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>


<% include ./footer.ejs %>